<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Good/Bad Days</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* Custom styles to supplement Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth; /* Smooth scrolling for the anchor link */
        }

        /* Style for the striped mixed day background */
        .mixed-day-bg {
            background-image: linear-gradient(
                45deg,
                #fecaca 25%, /* A light pink from Tailwind's red-200 */
                #a16207 25%, /* A brownish color from Tailwind's yellow-800 */
                #a16207 50%,
                #fecaca 50%,
                #fecaca 75%,
                #a16207 75%,
                #a16207 100%
            );
            background-size: 28.28px 28.28px; /* Controls the stripe size */
        }
        
        /* Ensure text inside striped background is readable */
        .mixed-day-bg .day-number {
             background-color: rgba(255, 255, 255, 0.7);
             border-radius: 9999px;
             padding: 0 0.25rem;
        }

        /* Styles for the day-editing modal */
        #day-modal {
            transition: opacity 0.2s ease-in-out;
        }

        /* Animation for when the calendar appears */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #calendar-container {
            animation: fadeIn 0.5s ease-out forwards;
        }
        
        /* Make calendar days feel clickable */
        .calendar-day {
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 p-4 sm:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header Section -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-slate-900">Good/Bad Days</h1>
            <p class="text-slate-600 mt-2">Create your calendar, then click Share to get a link for others!</p>
        </header>

        <!-- Input Form Section -->
        <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <!-- Title and Date Inputs -->
                <div>
                    <label for="calendar-title" class="block text-sm font-medium text-slate-700 mb-1">Optional Title</label>
                    <input type="text" id="calendar-title" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400" placeholder="e.g., My Summer Vacation">
                </div>
                <div>
                    <label for="start-date" class="block text-sm font-medium text-slate-700 mb-1">Start Date</label>
                    <input type="date" id="start-date" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-pink-400 focus:border-pink-400">
                </div>
                <div>
                    <label for="end-date" class="block text-sm font-medium text-slate-700 mb-1">End Date</label>
                    <input type="date" id="end-date" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-pink-400 focus:border-pink-400">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                 <!-- Day List Inputs -->
                <div>
                    <label for="good-days" class="block text-sm font-medium text-green-700 mb-1">Good Days üå∏</label>
                    <textarea id="good-days" rows="3" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-400 focus:border-green-400" placeholder="e.g., 2024-05-20 to 2024-05-22"></textarea>
                </div>
                <div>
                    <label for="bad-days" class="block text-sm font-medium text-red-700 mb-1">Bad Days üí©</label>
                    <textarea id="bad-days" rows="3" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-400 focus:border-red-400" placeholder="e.g., 2024-05-23"></textarea>
                </div>
                <div>
                    <label for="mixed-days" class="block text-sm font-medium text-yellow-700 mb-1">Mixed Days üåó</label>
                    <textarea id="mixed-days" rows="3" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400" placeholder="e.g., 2024-05-24"></textarea>
                </div>
            </div>
            <div class="mt-6 flex flex-col sm:flex-row items-center justify-center gap-4">
                <button id="generate-btn" class="w-full sm:w-auto bg-pink-500 text-white font-bold py-3 px-8 rounded-full hover:bg-pink-600 transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-pink-300">
                    Generate Calendar
                </button>
                <button id="share-btn" class="w-full sm:w-auto bg-sky-500 text-white font-bold py-3 px-8 rounded-full hover:bg-sky-600 transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-sky-300">
                    üîó Share
                </button>
            </div>
            <p class="text-xs text-slate-500 mt-4 text-center">Enter dates as YYYY-MM-DD. Use "to" for ranges (e.g., 2024-01-01 to 2024-01-05).</br>
            Or just Generate Calendar and then click on days to change their classification.</p>
        </div>

        <!-- ANCHOR and Title a user sees when opening a shared link -->
        <div id="calendar-view" class="mb-8">
            <!-- Fancy title will be injected here -->
        </div>

        <!-- Calendar Output Section -->
        <div id="calendar-container" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-8">
            <!-- Calendars will be dynamically inserted here -->
        </div>
    </div>
    
    <!-- Day Editing Modal -->
    <div id="day-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm text-center">
            <h3 class="text-lg font-bold mb-2">Change Day Type</h3>
            <p id="modal-date-display" class="text-slate-600 mb-4">Editing date...</p>
            <div class="grid grid-cols-2 gap-3">
                <button data-type="good" class="modal-btn bg-pink-200 text-pink-800 font-semibold py-3 rounded-lg hover:bg-pink-300">üå∏ Good</button>
                <button data-type="bad" class="modal-btn bg-yellow-900/80 text-yellow-100 font-semibold py-3 rounded-lg hover:bg-yellow-900">üí© Bad</button>
                <button data-type="mixed" class="modal-btn bg-gray-400 text-white font-semibold py-3 rounded-lg hover:bg-gray-500">üåó Mixed</button>
                <button data-type="neutral" class="modal-btn bg-slate-200 text-slate-800 font-semibold py-3 rounded-lg hover:bg-slate-300">‚ö™Ô∏è Neutral</button>
            </div>
            <button id="modal-close-btn" class="mt-4 text-sm text-slate-500 hover:text-slate-700">Cancel</button>
        </div>
    </div>


    <script>
        // --- DOM Element References ---
        const calendarTitleInput = document.getElementById('calendar-title');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const goodDaysTextarea = document.getElementById('good-days');
        const badDaysTextarea = document.getElementById('bad-days');
        const mixedDaysTextarea = document.getElementById('mixed-days');
        const generateBtn = document.getElementById('generate-btn');
        const shareBtn = document.getElementById('share-btn');
        const calendarView = document.getElementById('calendar-view');
        const calendarContainer = document.getElementById('calendar-container');
        const dayModal = document.getElementById('day-modal');
        const modalDateDisplay = document.getElementById('modal-date-display');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        // --- State Management ---
        let goodDays = new Set();
        let badDays = new Set();
        let mixedDays = new Set();
        let currentlyEditingDate = null;

        /**
         * Parses a string of dates, including ranges, into a Set of 'YYYY-MM-DD' strings.
         * @param {string} text - The raw text from the textarea.
         * @returns {Set<string>} A set of formatted date strings.
         */
        function parseDateListWithRanges(text) {
            const dateSet = new Set();
            if (!text) return dateSet;

            const entries = text.split(/[\n,]/).filter(Boolean);

            for (const entry of entries) {
                const trimmedEntry = entry.trim();
                if (trimmedEntry.toLowerCase().includes(' to ')) {
                    const [startStr, endStr] = trimmedEntry.toLowerCase().split(' to ');
                    const startDate = new Date(startStr.trim() + 'T00:00:00');
                    const endDate = new Date(endStr.trim() + 'T00:00:00');

                    if (!isNaN(startDate) && !isNaN(endDate) && startDate <= endDate) {
                        let currentDate = new Date(startDate);
                        while (currentDate <= endDate) {
                            dateSet.add(currentDate.toISOString().split('T')[0]);
                            currentDate.setDate(currentDate.getDate() + 1);
                        }
                    }
                } else if (/^\d{4}-\d{2}-\d{2}$/.test(trimmedEntry)) {
                    dateSet.add(trimmedEntry);
                }
            }
            return dateSet;
        }
        
        /**
         * Updates the textareas based on the current state of the date sets.
         */
        function updateAllTextareas() {
            goodDaysTextarea.value = [...goodDays].sort().join(', ');
            badDaysTextarea.value = [...badDays].sort().join(', ');
            mixedDaysTextarea.value = [...mixedDays].sort().join(', ');
            goodCountSpan = document.getElementById('good-count');
            if(goodCountSpan) {
              goodCountSpan.textContent = goodDays.size;
            }
            badCountSpan = document.getElementById('bad-count');
            if(badCountSpan) {
              badCountSpan.textContent = badDays.size;
            }
        }

        /**
         * Main function to render all calendars and the title based on user input.
         */
        function renderCalendars() {
            // Render the title first
            const title = calendarTitleInput.value.trim();
            calendarView.innerHTML = ''; // Clear previous title
            if (title) {
                const fancyTitle = document.createElement('h2');
                fancyTitle.className = 'text-3xl md:text-5xl font-bold text-center text-slate-800 break-words';
                // Using textContent for security to prevent HTML injection from user input
                fancyTitle.textContent = title; 
              calendarView.innerHTML = `<span class="text-3xl md:text-4xl" role="img" aria-label="flower">üå∏ <span id="good-count" class="text-slate-400">${goodDays.size}</span></span> ${fancyTitle.outerHTML} <span class="text-3xl md:text-4xl" role="img" aria-label="poop">üí© <span id="bad-count" class="text-slate-400">${badDays.size}</span></span>`;
                calendarView.classList.add('text-center');
            }


            const startDate = new Date(startDateInput.value + 'T00:00:00');
            const endDate = new Date(endDateInput.value + 'T00:00:00');

            if (isNaN(startDate) || isNaN(endDate) || startDate > endDate) {
                calendarContainer.innerHTML = `<div class="col-span-full text-center p-8 bg-red-100 text-red-700 rounded-lg">Please select a valid start and end date.</div>`;
                return;
            }

            goodDays = parseDateListWithRanges(goodDaysTextarea.value);
            badDays = parseDateListWithRanges(badDaysTextarea.value);
            mixedDays = parseDateListWithRanges(mixedDaysTextarea.value);

            calendarContainer.innerHTML = '';
            let currentDate = new Date(startDate.getFullYear(), startDate.getMonth(), 1);

            while (currentDate <= endDate) {
                const monthDiv = generateMonthCalendar(currentDate.getFullYear(), currentDate.getMonth());
                calendarContainer.appendChild(monthDiv);
                currentDate.setMonth(currentDate.getMonth() + 1);
            }
        }

        /**
         * Generates the HTML for a single month's calendar.
         * @param {number} year - The full year (e.g., 2024).
         * @param {number} month - The month index (0-11).
         * @returns {HTMLElement} The div element representing the month's calendar.
         */
        function generateMonthCalendar(year, month) {
            const monthWrapper = document.createElement('div');
            monthWrapper.className = 'bg-white p-4 rounded-xl shadow-md';
            const monthName = new Date(year, month).toLocaleString('default', { month: 'long', year: 'numeric' });
            
            let headerHTML = `<h3 class="text-xl font-bold text-center text-slate-800 mb-4">${monthName}</h3>`;
            headerHTML += `<div class="grid grid-cols-7 gap-1 text-center text-xs font-semibold text-slate-500 mb-2">
                <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
            </div>`;

            const daysGrid = document.createElement('div');
            daysGrid.className = 'grid grid-cols-7 gap-1';

            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDayOfMonth; i++) {
                daysGrid.appendChild(document.createElement('div'));
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateString = date.toISOString().split('T')[0];
                const dayCell = document.createElement('div');
                dayCell.dataset.date = dateString;
                dayCell.classList.add('calendar-day');
                updateDayCell(dayCell, dateString);
                daysGrid.appendChild(dayCell);
            }

            monthWrapper.innerHTML = headerHTML;
            monthWrapper.appendChild(daysGrid);
            return monthWrapper;
        }
        
        /**
         * Updates a single day cell's style and content based on its type.
         * @param {HTMLElement} dayCell - The DOM element for the day.
         * @param {string} dateString - The 'YYYY-MM-DD' date for the cell.
         */
        function updateDayCell(dayCell, dateString) {
            const day = new Date(dateString + 'T00:00:00').getDate();
            let cellClasses = 'h-20 sm:h-24 p-1.5 rounded-lg flex flex-col justify-between text-sm transition-all duration-200';
            let content = `<span class="day-number font-medium self-end">${day}</span><div class="text-2xl text-center"></div>`;
            
            dayCell.className = ''; 

            if (goodDays.has(dateString)) {
                cellClasses += ' bg-pink-200 text-pink-800';
                content = `<span class="day-number font-bold self-end">${day}</span><div class="text-2xl text-center leading-tight">üå∏<br>üòä</div>`;
            } else if (badDays.has(dateString)) {
                cellClasses += ' bg-yellow-900/80 text-yellow-100';
                content = `<span class="day-number font-bold self-end">${day}</span><div class="text-2xl text-center leading-tight">üí©<br>üòû</div>`;
            } else if (mixedDays.has(dateString)) {
                cellClasses += ' mixed-day-bg text-slate-900';
                content = `<span class="day-number font-bold self-end">${day}</span><div class="text-2xl text-center"></div>`;
            } else {
                cellClasses += ' bg-slate-100 hover:bg-slate-200';
            }
            
            dayCell.className = `calendar-day ${cellClasses}`;
            dayCell.innerHTML = content;
        }

        // --- Modal Handling ---
        function openDayModal(dateString) {
            currentlyEditingDate = dateString;
            const d = new Date(dateString + 'T00:00:00');
            modalDateDisplay.textContent = d.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            dayModal.classList.remove('hidden');
        }

        function closeDayModal() {
            dayModal.classList.add('hidden');
            currentlyEditingDate = null;
        }
        
        function handleDayTypeChange(newType) {
            if (!currentlyEditingDate) return;

            goodDays.delete(currentlyEditingDate);
            badDays.delete(currentlyEditingDate);
            mixedDays.delete(currentlyEditingDate);

            if (newType === 'good') goodDays.add(currentlyEditingDate);
            if (newType === 'bad') badDays.add(currentlyEditingDate);
            if (newType === 'mixed') mixedDays.add(currentlyEditingDate);
            
            const cellToUpdate = document.querySelector(`.calendar-day[data-date="${currentlyEditingDate}"]`);
            if (cellToUpdate) {
                updateDayCell(cellToUpdate, currentlyEditingDate);
            }

            updateAllTextareas();
            closeDayModal();
        }

        // --- Sharing and Clipboard ---
        /**
         * Copies text to the clipboard. Uses a fallback for broader compatibility.
         * @param {string} text - The text to copy.
         * @returns {boolean} - True if successful, false otherwise.
         */
        function copyToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.opacity = 0;
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                return document.execCommand('copy');
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
                return false;
            } finally {
                document.body.removeChild(textArea);
            }
        }

        function handleShareClick() {
            const url = new URL(window.location.href.split('?')[0]);
            const title = calendarTitleInput.value.trim();

            if (title) url.searchParams.set('title', title);
            if (startDateInput.value) url.searchParams.set('start', startDateInput.value);
            if (endDateInput.value) url.searchParams.set('end', endDateInput.value);
            
            if (goodDays.size > 0) url.searchParams.set('good', [...goodDays].sort().join(','));
            if (badDays.size > 0) url.searchParams.set('bad', [...badDays].sort().join(','));
            if (mixedDays.size > 0) url.searchParams.set('mixed', [...mixedDays].sort().join(','));

            const finalUrl = url.toString() + '#calendar-view';

            if (copyToClipboard(finalUrl)) {
                const originalText = shareBtn.innerHTML;
                shareBtn.innerHTML = '‚úÖ Copied!';
                shareBtn.disabled = true;
                setTimeout(() => {
                    shareBtn.innerHTML = originalText;
                    shareBtn.disabled = false;
                }, 2000);
            }
        }

        // --- Initialization ---
        function setDefaultDates() {
            const today = new Date();
            const firstDayCurrentMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDayCurrentMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);

            startDateInput.value = firstDayCurrentMonth.toISOString().split('T')[0];
            endDateInput.value = lastDayCurrentMonth.toISOString().split('T')[0];
        }

        function loadFromURLParams() {
            const params = new URLSearchParams(window.location.search);
            let hasParams = false;

            if (params.has('title')) {
                calendarTitleInput.value = params.get('title');
                hasParams = true;
            }
            if (params.has('start')) {
                startDateInput.value = params.get('start');
                hasParams = true;
            }
            if (params.has('end')) {
                endDateInput.value = params.get('end');
                hasParams = true;
            }
            if (params.has('good')) {
                goodDaysTextarea.value = params.get('good');
                hasParams = true;
            }
            if (params.has('bad')) {
                badDaysTextarea.value = params.get('bad');
                hasParams = true;
            }
            if (params.has('mixed')) {
                mixedDaysTextarea.value = params.get('mixed');
                hasParams = true;
            }

            if (hasParams) {
                renderCalendars();
            }
        }
        
        function init() {
            setDefaultDates();
            loadFromURLParams();

            // --- Event Listeners ---
            generateBtn.addEventListener('click', renderCalendars);
            shareBtn.addEventListener('click', handleShareClick);
            
            calendarContainer.addEventListener('click', (e) => {
                const dayCell = e.target.closest('.calendar-day');
                if (dayCell && dayCell.dataset.date) {
                    openDayModal(dayCell.dataset.date);
                }
            });

            dayModal.addEventListener('click', (e) => {
                if (e.target.matches('.modal-btn')) {
                    handleDayTypeChange(e.target.dataset.type);
                }
                if (e.target === modalCloseBtn || e.target === dayModal) {
                    closeDayModal();
                }
            });
        }

        window.onload = init;

    </script>
</body>
</html>
