<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Design by Eric Schulte, source at https://github.com/eschulte/sum-days. -->
    <title>Sum-Days</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåó</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3LCLV6N1K5"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-3LCLV6N1K5');
    </script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9366778713766437"
      crossorigin="anonymous"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* Custom styles to supplement Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth; /* Smooth scrolling for the anchor link */
        }
        .mixed-day-bg {
            background-image: linear-gradient(
                45deg, #fecaca 25%, #a16207 25%, #a16207 50%,
                #fecaca 50%, #fecaca 75%, #a16207 75%, #a16207 100%
            );
            background-size: 28.28px 28.28px;
        }
        .mixed-day-bg .day-number {
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 9999px;
            padding: 0 0.25rem;
        }
        #day-modal {
            transition: opacity 0.2s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #calendar-container {
            animation: fadeIn 0.5s ease-out forwards;
        }
        .calendar-day {
            cursor: pointer;
            user-select: none; /* Prevent text selection during drag */
        }
        /* Style for selected days */
        .day-selected {
            box-shadow: inset 0 0 0 3px #38bdf8; /* sky-500 */
            border-radius: 0.5rem; /* rounded-lg */
        }
        #form-container {
            transition: all 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 p-4 sm:p-8">

    <div class="max-w-7xl mx-auto">
        <header id="title-header" class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-slate-900">Sum-Days</h1>
            <p class="text-slate-600 mt-2">
              Create your calendar, mark your days, then click Share to get a link for others!
            </p>
        </header>

        <div id="form-wrapper">
            <div id="toggle-form-container" class="text-center mb-4 hidden">
                <button id="toggle-form-btn" class="bg-slate-200 text-slate-700 font-semibold py-2 px-6 rounded-full hover:bg-slate-300 transition">
                    ‚öôÔ∏è Show Calendar Details
                </button>
            </div>

            <div id="form-container" class="bg-white p-6 rounded-2xl shadow-lg mb-8 overflow-hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div>
                        <label for="calendar-title" class="block text-sm font-medium text-slate-700 mb-1">Required Title</label>
                        <input type="text" id="calendar-title" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-400" placeholder="e.g., My Summer Vacation">
                    </div>
                    <div>
                        <label for="start-date" class="block text-sm font-medium text-slate-700 mb-1">Start Date</label>
                        <input type="date" id="start-date" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-pink-400">
                    </div>
                    <div>
                        <label for="end-date" class="block text-sm font-medium text-slate-700 mb-1">End Date</label>
                        <input type="date" id="end-date" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-pink-400">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="good-days" class="block text-sm font-medium text-green-700 mb-1 flex items-center gap-2">
                            <span>Good Days</span>
                            <div class="relative w-8 h-6">
                                <span class="emoji-display absolute inset-0 flex items-center justify-center text-base cursor-pointer" title="Click to change emoji" data-input-id="good-emoji-input">üå∏</span>
                                <input type="text" id="good-emoji-input" value="üå∏" maxlength="2" class="absolute inset-0 w-full h-full p-0 text-center border rounded hidden">
                            </div>
                            <div class="relative w-8 h-6">
                                <span class="emoji-display absolute inset-0 flex items-center justify-center text-base cursor-pointer" title="Click to change emoji" data-input-id="good-secondary-emoji-input">üòä</span>
                                <input type="text" id="good-secondary-emoji-input" value="üòä" maxlength="2" class="absolute inset-0 w-full h-full p-0 text-center border rounded hidden">
                            </div>
                        </label>
                        <textarea id="good-days" rows="4" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-400" placeholder="e.g., 2024-08-08 to 2024-08-10"></textarea>
                    </div>
                    <div>
                        <label for="bad-days" class="block text-sm font-medium text-red-700 mb-1 flex items-center gap-2">
                            <span>Bad Days</span>
                            <div class="relative w-8 h-6">
                                <span class="emoji-display absolute inset-0 flex items-center justify-center text-base cursor-pointer" title="Click to change emoji" data-input-id="bad-emoji-input">üí©</span>
                                <input type="text" id="bad-emoji-input" value="üí©" maxlength="2" class="absolute inset-0 w-full h-full p-0 text-center border rounded hidden">
                            </div>
                            <div class="relative w-8 h-6">
                                <span class="emoji-display absolute inset-0 flex items-center justify-center text-base cursor-pointer" title="Click to change emoji" data-input-id="bad-secondary-emoji-input">üòû</span>
                                <input type="text" id="bad-secondary-emoji-input" value="üòû" maxlength="2" class="absolute inset-0 w-full h-full p-0 text-center border rounded hidden">
                            </div>
                        </label>
                        <textarea id="bad-days" rows="4" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-400" placeholder="e.g., 2024-08-11"></textarea>
                    </div>
                    <div>
                        <label for="mixed-days" class="block text-sm font-medium text-yellow-700 mb-1 flex items-center gap-2">
                            <span>Mixed Days</span>
                            <div class="relative w-8 h-6">
                                <span class="emoji-display absolute inset-0 flex items-center justify-center text-base cursor-pointer" title="Click to change emoji" data-input-id="mixed-emoji-input">üåó</span>
                                <input type="text" id="mixed-emoji-input" value="üåó" maxlength="2" class="absolute inset-0 w-full h-full p-0 text-center border rounded hidden">
                            </div>
                            <div class="relative w-8 h-6">
                                <span class="emoji-display absolute inset-0 flex items-center justify-center text-base cursor-pointer" title="Click to change emoji" data-input-id="mixed-secondary-emoji-input">ü§∑‚Äç‚ôÄÔ∏è</span>
                                <input type="text" id="mixed-secondary-emoji-input" value="ü§∑‚Äç‚ôÄÔ∏è" maxlength="2" class="absolute inset-0 w-full h-full p-0 text-center border rounded hidden">
                            </div>
                        </label>
                        <textarea id="mixed-days" rows="4" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-yellow-400" placeholder="e.g., 2024-08-12"></textarea>
                    </div>
                </div>
                <div class="grid grid-cols-1 gap-6"><span  style="margin:auto;float:center;color:gray;font-size:small;">(Click emojis to edit and customize their look and the normative valence of your calendar.)</span></div>
                <div class="mt-6 flex flex-col sm:flex-row items-center justify-center gap-4">
                    <button id="generate-btn" class="w-full sm:w-auto bg-pink-500 text-white font-bold py-3 px-8 rounded-full hover:bg-pink-600 transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-pink-300">
                        Generate Calendar
                    </button>
                    <button id="share-btn" class="w-full sm:w-auto bg-sky-500 text-white font-bold py-3 px-8 rounded-full hover:bg-sky-600 transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-sky-300">
                        üîó Share
                    </button>
                </div>
            </div>
        </div>

        <div id="calendar-view" class="mb-8"></div>

        <div id="calendar-container" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-8"></div>
    </div>
    
    <div id="day-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm text-center">
            <h3 class="text-lg font-bold mb-2">Change Day Type</h3>
            <p id="modal-date-display" class="text-slate-600 mb-4">Editing date...</p>
            <div class="grid grid-cols-2 gap-3">
                <button data-type="good" id="modal-good-btn" class="modal-btn bg-pink-200 text-pink-800 font-semibold py-3 rounded-lg hover:bg-pink-300">üå∏ Good</button>
                <button data-type="bad" id="modal-bad-btn" class="modal-btn bg-yellow-900/80 text-yellow-100 font-semibold py-3 rounded-lg hover:bg-yellow-900">üí© Bad</button>
                <button data-type="mixed" id="modal-mixed-btn" class="modal-btn mixed-day-bg text-slate-800 font-semibold py-3 rounded-lg hover:bg-yellow-900">üåó Mixed</button>
                <button data-type="neutral" class="modal-btn bg-slate-200 text-slate-800 font-semibold py-3 rounded-lg hover:bg-slate-300">‚ö™Ô∏è Neutral</button>
            </div>
            <button id="modal-close-btn" class="mt-4 text-sm text-slate-500 hover:text-slate-700">Cancel</button>
        </div>
    </div>


    <script>
        // --- DOM Element References ---
        const calendarTitleInput = document.getElementById('calendar-title'),
              startDateInput = document.getElementById('start-date'),
              endDateInput = document.getElementById('end-date'),
              goodEmojiInput = document.getElementById('good-emoji-input'),
              badEmojiInput = document.getElementById('bad-emoji-input'),
              mixedEmojiInput = document.getElementById('mixed-emoji-input'),
              goodSecondaryEmojiInput = document.getElementById('good-secondary-emoji-input'),
              badSecondaryEmojiInput = document.getElementById('bad-secondary-emoji-input'),
              mixedSecondaryEmojiInput = document.getElementById('mixed-secondary-emoji-input'),
              goodDaysTextarea = document.getElementById('good-days'),
              badDaysTextarea = document.getElementById('bad-days'),
              mixedDaysTextarea = document.getElementById('mixed-days'),
              generateBtn = document.getElementById('generate-btn'),
              shareBtn = document.getElementById('share-btn'),
              calendarView = document.getElementById('calendar-view'),
              calendarContainer = document.getElementById('calendar-container'),
              dayModal = document.getElementById('day-modal'),
              modalDateDisplay = document.getElementById('modal-date-display'),
              modalCloseBtn = document.getElementById('modal-close-btn'),
              modalGoodBtn = document.getElementById('modal-good-btn'),
              modalBadBtn = document.getElementById('modal-bad-btn'),
              modalMixedBtn = document.getElementById('modal-mixed-btn'),
              formContainer = document.getElementById('form-container'),
              toggleFormContainer = document.getElementById('toggle-form-container'),
              toggleFormBtn = document.getElementById('toggle-form-btn');

        // --- State Management ---
        let goodDays = new Set(), badDays = new Set(), mixedDays = new Set();
        let selectedDays = new Set();
        let isDragging = false;
        let startDragDate = null;
        let endDragDate = null;

        // NEW: Functions to generate and update the shareable URL in the address bar.
        let debounceTimer;
        function debounce(func, timeout = 300){
          return (...args) => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => { func.apply(this, args); }, timeout);
          };
        }

        function generateShareURL() {
            const dataToCompress = {
                title: calendarTitleInput.value.trim(),
                start: startDateInput.value,
                end: endDateInput.value,
                goodEmoji: goodEmojiInput.value,
                badEmoji: badEmojiInput.value,
                mixedEmoji: mixedEmojiInput.value,
                goodSecondaryEmoji: goodSecondaryEmojiInput.value,
                badSecondaryEmoji: badSecondaryEmojiInput.value,
                mixedSecondaryEmoji: mixedSecondaryEmojiInput.value,
                good: [...goodDays].sort().join(','),
                bad: [...badDays].sort().join(','),
                mixed: [...mixedDays].sort().join(',')
            };
            const compressedData = LZString.compressToEncodedURIComponent(JSON.stringify(dataToCompress));
            // Construct a clean URL without existing parameters or hash.
            return `${window.location.protocol}//${window.location.host}${window.location.pathname}?data=${compressedData}#calendar-view`;
        }

        function updateShareableURL() {
            const newUrl = generateShareURL();
            // Use replaceState to update the URL without adding to browser history.
            window.history.replaceState({ path: newUrl }, '', newUrl);
        }
        
        const debouncedUpdateURL = debounce(() => updateShareableURL());

        function parseDateListWithRanges(text) {
            const dateSet = new Set();
            if (!text) return dateSet;
            const entries = text.split(/[\n,]/).filter(Boolean);
            for (const entry of entries) {
                const trimmedEntry = entry.trim();
                if (trimmedEntry.toLowerCase().includes(' to ')) {
                    const [startStr, endStr] = trimmedEntry.toLowerCase().split(' to ');
                    const startDate = new Date(startStr.trim() + 'T00:00:00'), endDate = new Date(endStr.trim() + 'T00:00:00');
                    if (!isNaN(startDate) && !isNaN(endDate) && startDate <= endDate) {
                        let currentDate = new Date(startDate);
                        while (currentDate <= endDate) {
                            dateSet.add(currentDate.toISOString().split('T')[0]);
                            currentDate.setDate(currentDate.getDate() + 1);
                        }
                    }
                } else if (/^\d{4}-\d{2}-\d{2}$/.test(trimmedEntry)) {
                    dateSet.add(trimmedEntry);
                }
            }
            return dateSet;
        }
        
        function updateAllTextareas() {
            goodDaysTextarea.value = [...goodDays].sort().join(', ');
            badDaysTextarea.value = [...badDays].sort().join(', ');
            mixedDaysTextarea.value = [...mixedDays].sort().join(', ');
            const goodCountSpan = document.getElementById('good-count');
            if (goodCountSpan) goodCountSpan.textContent = goodDays.size;
            const badCountSpan = document.getElementById('bad-count');
            if (badCountSpan) badCountSpan.textContent = badDays.size;
            const mixedCountSpan = document.getElementById('mixed-count');
            if (mixedCountSpan) mixedCountSpan.textContent = mixedDays.size;
        }

        function renderCalendars() {
            // NEW: Ensure the title is set.
            let title = calendarTitleInput.value.trim();
            if (!title) {
                title = prompt("Please enter a title for your calendar:");
                if (title) {
                    calendarTitleInput.value = title;
                } else {
                    return; // Abort if user cancels the prompt
                }
            }
            
            // Update the page title to match the calendar title.
            document.title = title;
            
            // Collapse the form and title and show the toggle button
            document.getElementById('title-header').classList.add('hidden')
            formContainer.classList.add('hidden');
            toggleFormContainer.classList.remove('hidden');
            toggleFormBtn.innerHTML = '‚öôÔ∏è Show Calendar Details';

            const goodEmoji = goodEmojiInput.value.trim() || 'üå∏', badEmoji = badEmojiInput.value.trim() || 'üí©', mixedEmoji = mixedEmojiInput.value.trim() || 'üåó';
            calendarView.innerHTML = '';
            if (title) {
                const fancyTitle = document.createElement('h2');
                fancyTitle.className = 'text-3xl md:text-5xl font-bold text-center text-slate-800 break-words';
                fancyTitle.textContent = title; 
                calendarView.innerHTML = `
                    ${fancyTitle.outerHTML}
                    <div class="flex flex-row items-center justify-center gap-4">
                        <div class="text-3xl md:text-4xl flex items-center gap-2" role="img">
                            <span id="title-good-emoji-display">${goodEmoji}</span> <span id="good-count"></span>
                        </div>
                        <div class="text-3xl md:text-4xl flex items-center gap-2" role="img">
                            <span id="title-bad-emoji-display">${badEmoji}</span> <span id="bad-count"></span>
                        </div>
                        <div class="text-3xl md:text-4xl flex items-center gap-2" role="img">
                            <span id="title-mixed-emoji-display">${mixedEmoji}</span> <span id="mixed-count"></span>
                        </div>
                    </div>
                `;
                calendarView.classList.add('text-center');
            }
            const startDate = new Date(startDateInput.value + 'T00:00:00'), endDate = new Date(endDateInput.value + 'T00:00:00');
            if (isNaN(startDate) || isNaN(endDate) || startDate > endDate) {
                calendarContainer.innerHTML = `<div class="col-span-full text-center p-8 bg-red-100 text-red-700 rounded-lg">Please select a valid start and end date.</div>`;
                return;
            }
            goodDays = parseDateListWithRanges(goodDaysTextarea.value);
            badDays = parseDateListWithRanges(badDaysTextarea.value);
            mixedDays = parseDateListWithRanges(mixedDaysTextarea.value);
            calendarContainer.innerHTML = '';
            let currentDate = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
            while (currentDate <= endDate) {
                calendarContainer.appendChild(generateMonthCalendar(currentDate.getFullYear(), currentDate.getMonth(), startDate, endDate));
                currentDate.setMonth(currentDate.getMonth() + 1);
            }
            updateAllTextareas();
            // NEW: Update the URL whenever the calendar is generated.
            updateShareableURL();
        }

        function generateMonthCalendar(year, month, startDate, endDate) {
            const monthWrapper = document.createElement('div');
            monthWrapper.className = 'bg-white p-4 rounded-xl shadow-md';
            const monthName = new Date(year, month).toLocaleString('default', { month: 'long', year: 'numeric' });
            let headerHTML = `<h3 class="text-xl font-bold text-center text-slate-800 mb-4">${monthName}</h3><div class="grid grid-cols-7 gap-1 text-center text-xs font-semibold text-slate-500 mb-2"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div>`;
            const daysGrid = document.createElement('div');
            daysGrid.className = 'grid grid-cols-7 gap-1';
            
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            let startingDayOfWeek;
            if (year === startDate.getFullYear() && month === startDate.getMonth()) {
                // For the first month in the range, offset by the *start date's* day of the week.
                startingDayOfWeek = startDate.getDay();
            } else {
                // For all subsequent months, offset by the first day of that month.
                startingDayOfWeek = new Date(year, month, 1).getDay();
            }
            // Add empty divs to pad the grid so the first day appears in the correct column.
            for (let i = 0; i < startingDayOfWeek; i++) {
                daysGrid.appendChild(document.createElement('div'));
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayDate = new Date(year, month, day);
                if (dayDate >= startDate && dayDate <= endDate) {
                    const dateString = dayDate.toISOString().split('T')[0];
                    const dayCell = document.createElement('div');
                    dayCell.dataset.date = dateString;
                    dayCell.classList.add('calendar-day');
                    updateDayCell(dayCell, dateString);
                    daysGrid.appendChild(dayCell);
                }
            }
            
            monthWrapper.innerHTML = headerHTML;
            monthWrapper.appendChild(daysGrid);
            return monthWrapper;
        }
        
        function updateDayCell(dayCell, dateString) {
            const goodEmoji = goodEmojiInput.value.trim() || 'üå∏', badEmoji = badEmojiInput.value.trim() || 'üí©', mixedEmoji = mixedEmojiInput.value.trim() || 'üåó';
            const goodSecondaryEmoji = goodSecondaryEmojiInput.value.trim() || '&nbsp;';
            const badSecondaryEmoji = badSecondaryEmojiInput.value.trim() || '&nbsp;';
          const mixedSecondaryEmoji = mixedSecondaryEmojiInput.value.trim() || '&nbsp;';
            const day = new Date(dateString + 'T00:00:00').getDate();
            let cellClasses = 'h-20 sm:h-24 p-1.5 rounded-lg flex flex-col justify-between text-sm transition-all duration-200';
            let content = `<span class="day-number font-medium self-end">${day}</span><div class="text-2xl text-center"></div>`;
            if (goodDays.has(dateString)) {
                cellClasses += ' bg-pink-200 text-pink-800';
                content = `<span class="day-number font-bold self-end">${day}</span><div class="text-2xl text-center leading-tight">${goodEmoji}<br>${goodSecondaryEmoji}</div>`;
            } else if (badDays.has(dateString)) {
                cellClasses += ' bg-yellow-900/80 text-yellow-100';
                content = `<span class="day-number font-bold self-end">${day}</span><div class="text-2xl text-center leading-tight">${badEmoji}<br>${badSecondaryEmoji}</div>`;
            } else if (mixedDays.has(dateString)) {
                cellClasses += ' mixed-day-bg text-slate-900';
                content = `<span class="day-number font-bold self-end">${day}</span><div class="text-2xl text-center leading-tight">${mixedEmoji}<br>${mixedSecondaryEmoji}</div>`;
            } else {
                cellClasses += ' bg-slate-100 hover:bg-slate-200';
            }
            dayCell.className = `calendar-day ${cellClasses}`;
            dayCell.innerHTML = content;
        }

        function clearSelectionStyles() {
            document.querySelectorAll('.day-selected').forEach(el => el.classList.remove('day-selected'));
        }

        function openDayModal() {
            if (selectedDays.size === 0) return;
            if (selectedDays.size === 1) {
                const d = new Date([...selectedDays][0] + 'T00:00:00');
                modalDateDisplay.textContent = d.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            } else {
                modalDateDisplay.textContent = `Editing ${selectedDays.size} days`;
            }
            dayModal.classList.remove('hidden');
        }

        function closeDayModal() {
            dayModal.classList.add('hidden');
            clearSelectionStyles();
            selectedDays.clear();
        }
        
        function handleDayTypeChange(newType) {
            if (selectedDays.size === 0) return;
            for (const date of selectedDays) {
                goodDays.delete(date); badDays.delete(date); mixedDays.delete(date);
                if (newType === 'good') goodDays.add(date);
                if (newType === 'bad') badDays.add(date);
                if (newType === 'mixed') mixedDays.add(date);
                const cellToUpdate = document.querySelector(`.calendar-day[data-date="${date}"]`);
                if (cellToUpdate) updateDayCell(cellToUpdate, date);
            }
            updateAllTextareas();
            updateShareableURL();
            closeDayModal();
        }
        
        function updateDynamicEmojis() {
            const goodEmoji = goodEmojiInput.value.trim() || 'üå∏', badEmoji = badEmojiInput.value.trim() || 'üí©', mixedEmoji = mixedEmojiInput.value.trim() || 'üåó';
            const goodSecondaryEmoji = goodSecondaryEmojiInput.value.trim() || '&nbsp;';
            const badSecondaryEmoji = badSecondaryEmojiInput.value.trim() || '&nbsp;';
            const mixedSecondaryEmoji = mixedSecondaryEmojiInput.value.trim() || '&nbsp;';

            document.querySelector('.emoji-display[data-input-id="good-emoji-input"]').textContent = goodEmoji;
            document.querySelector('.emoji-display[data-input-id="good-secondary-emoji-input"]').textContent = goodSecondaryEmoji;
            document.querySelector('.emoji-display[data-input-id="bad-emoji-input"]').textContent = badEmoji;
            document.querySelector('.emoji-display[data-input-id="bad-secondary-emoji-input"]').textContent = badSecondaryEmoji;
            document.querySelector('.emoji-display[data-input-id="mixed-emoji-input"]').textContent = mixedEmoji;
            document.querySelector('.emoji-display[data-input-id="mixed-secondary-emoji-input"]').textContent = mixedSecondaryEmoji;

            modalGoodBtn.innerHTML = `${goodEmoji} Good`;
            modalBadBtn.innerHTML = `${badEmoji} Bad`;
            modalMixedBtn.innerHTML = `${mixedEmoji} Mixed`;

            const titleGoodEmoji = document.getElementById('title-good-emoji-display');
            if (titleGoodEmoji) titleGoodEmoji.textContent = goodEmoji;
            const titleBadEmoji = document.getElementById('title-bad-emoji-display');
            if (titleBadEmoji) titleBadEmoji.textContent = badEmoji;
            const titleMixedEmoji = document.getElementById('title-mixed-emoji-display');
            if (titleMixedEmoji) titleMixedEmoji.textContent = mixedEmoji;
        }

        function handleShareClick() {
            const finalUrl = generateShareURL();
            window.history.replaceState({ path: finalUrl }, '', finalUrl); // Ensure URL is latest
            const originalText = shareBtn.innerHTML;
            if (navigator.clipboard) {
                navigator.clipboard.writeText(finalUrl).then(() => { shareBtn.innerHTML = '‚úÖ Copied!'; }).catch(() => { shareBtn.innerHTML = '‚ùå Copy Failed'; });
            }
            shareBtn.disabled = true;
            setTimeout(() => { shareBtn.innerHTML = originalText; shareBtn.disabled = false; }, 2000);
        }

        function setDefaultDates() {
            const defaultDate = new Date('2025-08-08T12:00:00');
            const firstDayOfMonth = new Date(defaultDate.getFullYear(), defaultDate.getMonth(), 1);
            const lastDayOfMonth = new Date(defaultDate.getFullYear(), defaultDate.getMonth() + 1, 0);
            startDateInput.value = firstDayOfMonth.toISOString().split('T')[0];
            endDateInput.value = lastDayOfMonth.toISOString().split('T')[0];
        }

        function loadFromURLParams() {
            const params = new URLSearchParams(window.location.search);
            if (!params.has('data')) return;
            try {
                const jsonString = LZString.decompressFromEncodedURIComponent(params.get('data'));
                if (!jsonString) throw new Error("Decompression failed");
                const data = JSON.parse(jsonString);
                calendarTitleInput.value = data.title || ''; startDateInput.value = data.start || ''; endDateInput.value = data.end || '';
                goodEmojiInput.value = data.goodEmoji || 'üå∏'; badEmojiInput.value = data.badEmoji || 'üí©'; mixedEmojiInput.value = data.mixedEmoji || 'üåó';
                goodSecondaryEmojiInput.value = data.goodSecondaryEmoji || '&nbsp;';
                badSecondaryEmojiInput.value = data.badSecondaryEmoji || '&nbsp;';
                mixedSecondaryEmojiInput.value = data.mixedSecondaryEmoji || '&nbsp;';
                goodDaysTextarea.value = data.good || ''; badDaysTextarea.value = data.bad || ''; mixedDaysTextarea.value = data.mixed || '';
                updateDynamicEmojis(); renderCalendars();
            } catch (error) {
                console.error("Failed to load data from URL:", error);
                alert("Could not load the shared calendar data. It may be corrupted.");
            }
        }
        
        function initEmojiTogglers() {
            document.querySelectorAll('.emoji-display').forEach(span => {
                span.addEventListener('click', () => {
                    const input = document.getElementById(span.dataset.inputId);
                    // Use a prompt box instead of a hidden input field
                    const newEmoji = prompt(`Enter a new emoji for ${input.id.replace('-emoji-input', '')}:`, input.value);
                    if (newEmoji !== null) {
                        input.value = newEmoji.trim().substring(0, 2); // Limit to 2 characters for some emoji combinations
                        updateDynamicEmojis();
                        if (calendarContainer.innerHTML.trim() !== '') {
                                renderCalendars();
                            } else {
                                updateShareableURL();
                            }
                    }
                });
            });
        }

        function selectDayRange(startDate, endDate) {
            clearSelectionStyles();
            selectedDays.clear();
            
            const start = new Date(startDate + 'T00:00:00');
            const end = new Date(endDate + 'T00:00:00');
            
            let loopStart = start < end ? start : end;
            let loopEnd = start < end ? end : start;
            
            for (let d = new Date(loopStart); d <= loopEnd; d.setDate(d.getDate() + 1)) {
                const dateString = d.toISOString().split('T')[0];
                selectedDays.add(dateString);
                const cell = document.querySelector(`.calendar-day[data-date="${dateString}"]`);
                if (cell) cell.classList.add('day-selected');
            }
        }

        function init() {
            setDefaultDates(); loadFromURLParams(); initEmojiTogglers();
            generateBtn.addEventListener('click', renderCalendars);
            shareBtn.addEventListener('click', handleShareClick);

            const inputsToTrack = [
                calendarTitleInput, startDateInput, endDateInput,
                goodDaysTextarea, badDaysTextarea, mixedDaysTextarea
            ];
            inputsToTrack.forEach(input => {
                input.addEventListener('input', () => {
                    // When typing in textareas, we must re-parse the dates to update the underlying
                    // state (the Sets) before generating the share URL.
                    if (['good-days', 'bad-days', 'mixed-days'].includes(input.id)) {
                        goodDays = parseDateListWithRanges(goodDaysTextarea.value);
                        badDays = parseDateListWithRanges(badDaysTextarea.value);
                        mixedDays = parseDateListWithRanges(mixedDaysTextarea.value);
                    }
                    // Use a debounced function to avoid updating the URL on every single keystroke.
                    debouncedUpdateURL();
                });
            });

            toggleFormBtn.addEventListener('click', () => {
                document.getElementById('title-header').classList.toggle('hidden');
                const isHidden = formContainer.classList.toggle('hidden');
                toggleFormBtn.innerHTML = isHidden ? '‚öôÔ∏è Show Calendar Details' : '‚öôÔ∏è Hide Calendar Details';
            });
            
            calendarContainer.addEventListener('mousedown', (e) => {
                const dayCell = e.target.closest('.calendar-day');
                if (!dayCell) return;
                e.preventDefault(); // Prevents default browser drag behavior
                isDragging = true;
                startDragDate = dayCell.dataset.date;
                endDragDate = dayCell.dataset.date;
                selectDayRange(startDragDate, endDragDate);
            });

            calendarContainer.addEventListener('mouseover', (e) => {
                if (!isDragging) return;
                const dayCell = e.target.closest('.calendar-day');
                if (!dayCell) return;
                endDragDate = dayCell.dataset.date;
                selectDayRange(startDragDate, endDragDate);
            });

            calendarContainer.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    openDayModal();
                }
            });

            // Handle mouseup anywhere on the window in case the user drags off the calendar
            window.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    openDayModal();
                }
            });

            dayModal.addEventListener('click', (e) => {
                if (e.target.matches('.modal-btn')) handleDayTypeChange(e.target.dataset.type);
                if (e.target === modalCloseBtn || e.target === dayModal) closeDayModal();
            });
        }
        window.onload = init;
    </script>
</body>
</html>
